<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>PV Interpellation â€” ESI</title>

<meta name="theme-color" content="#003366" />
<link rel="apple-touch-icon" href="../icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --brand:#003366;
  --bg:#f4f6fa;
  --text:#222;
  --radius:18px;
  --serif:"Times New Roman", Times, serif;
  --ui:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

html, body {
  margin:0; padding:0;
  font-family:var(--ui);
  background:var(--bg);
  color:var(--text);
}

header {
  background:var(--brand);
  color:white;
  text-align:center;
  padding:15px 10px;
  font-weight:bold;
  font-size:1.3em;
  letter-spacing:0.5px;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
  position:sticky;
  top:0;
  z-index:100;
}

/* MENU PRINCIPAL */
#homePage {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:20px;
  padding:25px;
  max-width:700px;
  margin:auto;
}

.menu-btn {
  background:white;
  border-radius:var(--radius);
  padding:25px 10px;
  text-align:center;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
  transition:all 0.2s ease;
  border:2px solid transparent;
}
.menu-btn:hover {
  transform:scale(1.03);
  border-color:var(--brand);
}
.menu-btn i {
  font-size:2em;
  margin-bottom:10px;
  color:var(--brand);
}
.menu-btn span {
  display:block;
  font-weight:600;
  color:var(--brand);
}

/* SECTIONS */
section {
  display:none;
  padding:20px;
  max-width:980px;
  margin:auto;
}
section.active { display:block; }

.grid {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:12px;
  }
fieldset {
  border:1px solid #d0d7de;
  border-radius:10px;
  padding:12px;
  background:#a8c7ff;
  
}

legend {
  padding:0 8px;
  color:#111;
  font-weight:700;
}

label {
  display:block;
  font-size:14px;
  margin:8px 0 4px;
}
input, select, textarea {
  width:100%;
  padding:10px;
  border:1px solid #c9c9c9;
  border-radius:8px;
  font-size:14px;
}

.row {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .row3 {
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
  }
  
.back-btn {
  display:inline-block;
  background:var(--brand);
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 18px;
  margin-top:15px;
  font-size:1em;
  text-decoration:none;
}
.back-btn:hover { background:#004c9c; }

/* ZONE PV
#sheet {
  width:210mm;
  min-height:297mm;
  background:#fff;
  color:#000;
  font-family:var(--serif);
  padding:10mm;
  display:none;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}*/

/* âœ… Mise en page identique Ã  lâ€™Ã©cran et au PDF */
#sheet {
  width: 210mm;
  min-height: 297mm;
  display: none;
  grid-template-columns: 58mm 1fr; /* colonne gauche et droite */
  gap: 8mm;
  background: white;
  color: black;
  font-family: "Times New Roman", serif;
  padding: 10mm;
  margin: 30px auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  box-sizing: border-box;
}

#sheet .col-g {
  border-right: 1px solid #aaa;
  padding-right: 5mm;
}

#sheet .col-d {
  padding-left: 4mm;
  text-align: justify;
  line-height: 1.42;
}

.logo {
  width: 60mm;
  margin: 0 0 8mm 0;
}

.signzone {
  margin-top: 16mm;
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.signcell {
  min-height: 28mm;
  border-top: 1px solid #aaa;
  padding-top: 4mm;
}

/* Impression */
@media print {
  body>*:not(#sheet){display:none !important}
  #sheet{display:grid !important;position:static;margin:0}
}

/* ======== RESPONSIVE DESIGN ======== */

  @media (max-width: 900px) {
    .wrap {
      padding:12px;
      margin:10px;
    }
    .grid, .row, .row3 {
      grid-template-columns:1fr; /* Les champs sâ€™empilent */
    }
    fieldset {
      padding:10px;
    }
  }

  @media (max-width: 600px) {
    body {
      font-size:15px;
    }
    .toolbar {
      flex-direction:column;
      gap:10px;
    }
    .toolbar button {
      width:100%;
      font-size:16px;
    }
    input, select, textarea {
      font-size:16px; /* Ã‰vite le zoom sur iPhone */
    }
    .wrap {
      padding:10px;
    }
  }

  /* âœ… Correction ciblÃ©e : empÃªche les champs d'Ã©criture de dÃ©passer des cartes */
fieldset input,
fieldset select,
fieldset textarea {
  box-sizing: border-box;
  max-width: 100%;
  width: 100%;
}
/* âœ… Corrige l'espacement du numÃ©ro de PV (prÃ©visualisation) */
.num-pv {
  display: block;
  margin-top: 8mm;      /* espace vertical sous "GENDARMERIE NATIONALE" */
  font-style: italic;
}
#sign_col_g {
  letter-spacing: 1px;
  word-spacing: 20px;
}

/* ğŸ§­ Menu dÃ©roulant mobile-friendly */
/*#optionsMenu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* 2 colonnes sur PC, 1 sur mobile */
  gap: 12px;
  width: 100%;
}*/
#optionsMenu {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* â¬…ï¸ FORCÃ‰ : 2 colonnes fixes */
  gap: 12px;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
}


/* ğŸ¨ Style des boutons */
#optionsMenu button {
  min-height: 64px;
  padding: 14px 20px;
  background: linear-gradient(180deg, #0d6efd, #003366);
  color: white;
  border: none;
  border-radius: 14px;
  font-size: 1.50em;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.25);
  transition: all 0.15s ease;
  cursor: pointer;
  text-align: center;
}

#optionsMenu button i {
  font-size: 1.4em;
}

#optionsMenu button:hover {
  background: linear-gradient(180deg, #0055cc, #002b66);
}

#optionsMenu button:active {
  transform: scale(0.96);
}

/* ğŸ”™ Bouton retour */
.back-btn {
  background: white;
  color: #003366;
  border: 2px solid #003366;
  border-radius: 10px;
  padding: 10px 18px;
  text-decoration: none;
  font-weight: 600;
  transition: 0.2s;
}
.back-btn:hover {
  background: #003366;
  color: white;
}

#scrollTopBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 100;
  background: linear-gradient(180deg, #0d6efd, #003366);
  color: white;
  border: none;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  font-size: 1.4em;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0,0,0,0.25);
  cursor: pointer;
  transition: 0.2s ease;
}

#scrollTopBtn:hover {
  transform: scale(1.08);
  background: linear-gradient(180deg, #0055cc, #002b66);
}

.btn-fermer {
  position: relative;       /* ancrÃ© dans le flux du PV */
  float: left;              /* ğŸ”¹ colle le bouton Ã  gauche du PV */
  margin-top: 10px;         /* ğŸ”¹ espace avec le haut */
  margin-left: 10px;        /* ğŸ”¹ lÃ©ger retrait du bord gauche */
  margin-bottom: 15px;      /* ğŸ”¹ espace sous le bouton avant le PV */
  background: #b00000;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-weight: bold;
  cursor: pointer;
  z-index: 10;              /* passe au-dessus du contenu du PV */
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.btn-fermer:hover {
  background: #d00000;
}


/* petit effet fondu Ã  lâ€™apparition/disparition */
.btn-fermer[style*="display: none"] {
  opacity: 0;
}

#toast {
  position: fixed;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 8px 14px;
  font-size: 12px;
  border-radius: 8px;
  z-index: 9999;
  display: none;
}

@page {
  size: A4;
  margin: 10mm 10mm 20mm 10mm;
}

@media print {
  body {
    margin: 0;
    padding: 0;
    background: #ffffff;
    color: #000000;
    font-family: "Times New Roman", serif;
  }

  /* On masque toute l'interface, on garde uniquement le PV */
  body > *:not(#sheet) {
    display: none !important;
  }

  #sheet {
    display: grid !important;
    position: static !important;
    margin: 0 auto !important;
    width: 210mm !important;
    min-height: 297mm !important;
    box-shadow: none !important;
    background: #ffffff !important;
    color: #000000 !important;
  }
}

</style>
</head>

<body>


<!-- MENU PRINCIPAL -->
<div id="homePage">
  <div class="menu-btn" onclick="showSection('redacteur')">
    <i class="fa-solid fa-user-pen"></i><span>RÃ©dacteur</span>
  </div>
  <div class="menu-btn" onclick="showSection('assistants')">
    <i class="fa-solid fa-people-group"></i><span>Assistant(s)</span>
  </div>
  <div class="menu-btn" onclick="showSection('mission')">
    <i class="fa-solid fa-shield-halved"></i><span>Mission</span>
  </div>
  <div class="menu-btn" onclick="showSection('esi')">
    <i class="fa-solid fa-id-card"></i><span>ESI contrÃ´lÃ©</span>
  </div>
  <div class="menu-btn" onclick="showSection('options')">
    <i class="fa-solid fa-gear"></i><span>Options</span>
  </div>
</div>

<!-- SECTION RÃ‰DACTEUR -->
<section id="redacteur">
  <fieldset>
   <legend>ESR (rÃ©dacteur)</legend>
        <label>Grade</label>
        <input id="esr_grade" placeholder="ex: Gendarme" />
        <label>Nom</label>
        <input id="esr_nom"
       placeholder="NOM"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
        <label>PrÃ©nom</label>
        <input id="esr_prenom" placeholder="PrÃ©nom" />
        <label>Sexe ESR (accord de Â« assistÃ©(e) Â»)</label>
        <select id="esr_sexe"><option value="m">Masculin</option><option value="f">FÃ©minin</option></select>
     <label>QualitÃ©</label>
<select id="esr_qualite">
  <option value="">â€” SÃ©lectionner â€”</option>
  <option value="APJA">APJA</option>
  <option value="APJ">APJ</option>
  <option value="OPJ">OPJ</option>
  <option value="AFP">AFP</option>
</select>



        <label>Affectation</label>
        <input id="esr_affect" placeholder="ex: CRT 06/1 Nice" />
        <div class="row">
          <div>
            <label>NumÃ©ro de PV</label>
            <input id="pv_num" placeholder="(ex: 2025 / )" />
          </div>
          <div>
  </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">â¬… Retour</a>
</section>

<!-- SECTION ASSISTANTS -->
<section id="assistants">
  <fieldset>
   <legend>Assistants (multi)</legend>
        <div id="assist_list"></div>
        <button type="button" class="add-btn" onclick="addAssistant()">
  <i class="fa-solid fa-user-plus"></i> Ajouter un assistant
</button>
    </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">â¬… Retour</a>
</section>

<!-- SECTION MISSION -->
<section id="mission">
  <fieldset>
    <legend>Mission</legend>
    <label>Lieu de mission</label>
    <input id="mission_lieu" placeholder="ex: La Turbie" />
    <div class="row">
      <div>
        <label>Heure dÃ©but</label>
        <input id="mission_hdeb" type="time" />
      </div>
      <div>
        <label>Heure fin</label>
        <input id="mission_hfin" type="time" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Date (lettres)</label>
        <input id="date_lettres" placeholder="17 Juillet" />
      </div>
      <div>
        <label>Heure avant constatation</label>
        <input id="heure_lettres" type="time" />
      </div>
    </div>
  </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">â¬… Retour</a>
</section>

<!-- SECTION ESI CONTRÃ”LÃ‰ -->
<section id="esi">
  <fieldset>
    <legend>ESI contrÃ´lÃ©</legend>
        <div class="row">
          <div>
            <label>Heure de constatation (lettres)</label>
            <input id="esi_hconstat" type="time" placeholder="16 heures et 30 minutes" />
          </div>
          <div>
           <label for="veh_type">VÃ©hicule/Pieton</label>

<select id="veh_type">
  <option value="" selected disabled>â€” SÃ©lectionner â€”</option>
  <option value="bus">Bus</option>
  <option value="train">Train</option>
  <option value="VL">VÃ©hicule lÃ©ger</option>
  <option value="PL">Poids lourd</option>
  <option value="personne">Personne</option>
</select>
          </div>
        </div>
		<label>Marque du vÃ©hicule/Compagnie du train/bus</label>
<input id="veh_marque"placeholder="ex:Renault/Tranitalia/Flixbus" />

        <label>Immatriculation / nÂ° de train</label>
        <input id="veh_immat" 
       placeholder="AA-123-BB / TGV 6123" 
       style="text-transform:uppercase" 
       oninput="this.value=this.value.toUpperCase()" 
       autocorrect="off" 
       autocapitalize="characters" 
       spellcheck="false">

		<label for="veh_pays">Pays dâ€™immatriculation</label>
<input id="veh_pays" placeholder="ex: en Italie"
oninput="if(this.value) this.value = this.value.charAt(0).toLowerCase() + this.value.slice(1)">

<label>Conducteur / Conductrice</label>
<select id="conducteur_genre">
  <option value="m">Conducteur</option>
  <option value="f">Conductrice</option>
</select>

        <label>Lieu du contrÃ´le</label>
        <input id="lieu_controle" placeholder="ex: sur le bas cÃ´tÃ©" 
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
        <label>PiÃ¨ce dâ€™identitÃ© prÃ©sentÃ©e</label>
        <input id="piece_id" placeholder="ex: passeport sans visa/ titre de sÃ©jour pÃ©rimÃ©"
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
        <div class="row3">
          <div>
<small>âš ï¸SI PAS DE PIECE D'IDENTITÃ‰ NE RIEN ECRIREâš ï¸
            <label>Nom</label>
            <input id="esi_nom"
       placeholder="NOM ESI"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
          </div>
          <div>
            <label>PrÃ©nom</label>
            <input id="esi_prenom" placeholder="prÃ©nom esi" />
          </div>
          <div>
            <label>Sexe</label>
            <select id="esi_sexe"><option value="m">Masculin</option><option value="f">FÃ©minin</option></select>
          </div>
        </div>
        <div class="row3">
          <div>
           <label>Date de naissance</label>
<input id="esi_dnaiss" type="text" maxlength="10" placeholder="jj/mm/aaaa" oninput="formatDateNaissance(this)">

          </div>
          <div>
            <label>Lieu de naissance</label>
            <input id="esi_lnaiss" placeholder="ex:DAKAR (SENEGAL)"
style="text-transform:uppercase" 
       oninput="this.value=this.value.toUpperCase()" 
       autocorrect="off" 
       autocapitalize="characters" 
       spellcheck="false">
          </div>
          <div>
            <label>NationalitÃ©</label>
            <input id="esi_nat" placeholder="ex: sÃ©nÃ©galaise" 
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
          </div>
        </div>
		<label>Langue parlÃ©e</label>
<select id="esi_langue">
  <option value="fr_ok">Parle franÃ§ais</option>
  <option value="fr_approx">FranÃ§ais approximatif</option>
  <option value="npf">Ne parle pas franÃ§ais</option>
</select>

        <div class="row3">
          <div>
            <label>FPR</label>
            <select id="fpr"><option>NÃ©gatif</option><option>Positif</option></select>
          </div>
          <div>
            <label>AGDREF</label>
            <select id="agdref"><option>NÃ©gatif</option><option>Positif</option></select>
          </div>
          <div>
            <label>Fichiers nationaux (ex:OQTF,RAS,AUTRE)</label>
            <input id="fichiers_nat" placeholder="OQTF" />
          </div>
        </div>
        <div class="row">
         <div>
  <label>Palpation (genre de lâ€™agent qui palpe)</label>
  <select id="palp_genre" onchange="majPalpation()">
    <option value="">â€” SÃ©lectionner â€”</option>
    <option value="m">Masculin</option>
    <option value="f">FÃ©minin</option>
    <option value="impossible">Impossible (pas de personnel du mÃªme sexe)</option>
  </select>
</div>

<div>
  <label>Objets trouvÃ©s sur lâ€™individu</label>
  <input type="text" id="objets_trouves" placeholder="ex : couteau pliant, briquet" oninput="majPalpation()">
</div>
<small>âš ï¸SI PAS D'OBJET NE RIEN ECRIREâš ï¸
          <div>
            <label>VÃ©hicule de transport</label>
            <select id="transport_type"><option>GENDARMERIE</option><option>Translation Police</option></select>
          </div>
        </div>
        <label>PAF de prÃ©sentation (ville)</label>
        <input id="paf_ville" placeholder="Menton / Nice / AÃ©roport" />
		<label>Heure de prÃ©sentation Ã  la PAF</label>
<input id="paf_heure" type="time" placeholder="ex: 17 heures et 10 minutes" />
  </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">â¬… Retour</a>
</section>

<!-- SECTION OPTIONS -->
<section id="options">
  <div class="toolbar" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;flex-direction:column;align-items:center;">
    <a href="#" class="back-btn" onclick="backHome()">â¬… Retour</a>

    <!-- ğŸ”½ Bouton principal -->
    <button id="toggleOptions" style="background:#003366;color:white;border:none;border-radius:10px;padding:12px 20px;font-size:1.1em;cursor:pointer;">
      âš™ï¸ MENU
    </button>

   <!-- ğŸ”½ Menu dÃ©roulant masquÃ© par dÃ©faut -->
<div id="optionsMenu" style="display:none;flex-direction:column;gap:8px;margin-top:10px;">
  <button onclick="generatePV()"><i class="fa-solid fa-file-lines"></i> GÃ©nÃ©rer le PV</button>
  <button class="secondary" onclick="openPrintPreview()"><i class="fa-solid fa-print"></i> Imprimer / PDF</button>
  <button id="sendMailBtn"><i class="fa-solid fa-envelope"></i> Envoyer par mail</button>
  <button onclick="sauvegarderPV()"><i class="fa-solid fa-floppy-disk"></i> Sauvegarder le PV</button>
  <button onclick="ouvrirMesPV()"><i class="fa-solid fa-folder-open"></i> Mes PV sauvegardÃ©s</button>
  <button onclick="nouveauPV()"><i class="fa-solid fa-plus"></i> Nouveau PV</button>
</div>
  </div>
 <button id="closePVBtn" class="btn-fermer" onclick="fermerPV()" style="display:none;">âŒ Fermer</button>


   <h2>ProcÃ¨s-verbal gÃ©nÃ©rÃ©:</h2>
   <div id="sheet">
    <div class="col-g">
      <div class="title-left">MINISTERE DE L'INTERIEUR</div>
      <div style="margin-top:2mm"></div>
      <hr style="border:none;border-top:1px solid #000;margin:3mm 0 2mm 0">
      <div class="title-left" style="white-space:pre-line">DIRECTION GENERALE
DE LA POLICE NATIONALE

DIRECTION GÃ‰NÃ‰RALE DE LA GENDARMERIE     NATIONALE</div>
      <div class="num-pv">NUMÃ‰RO DE P.V. : <span id="pv_num_o"></span></div>

      <div style="margin-top:8mm">AFFAIRE :</div>
     
      <div style="margin-top:8mm"><span id="esi_civil_left_o">Monsieur</span> <span id="aff_nomcomplet_o">Nom PrÃ©nom</span></div>
      <div style="margin-top:6mm">OBJET :</div>
      <div>Rapport de saisine</div>
      <div style="margin-top:6mm">SAISINE :</div>
      <div>Interpellation dâ€™Ã©tranger en situation irrÃ©guliÃ¨re.</div>

      <div id="sign_col_g" style="margin-top:18mm">Lâ€™assistant Lâ€™APJA</div>
    </div>

    <div class="col-d">
      <div style="text-align:center;font-weight:bold;font-size:1.6em;letter-spacing:1px;">
  RÃ‰PUBLIQUE FRANÃ‡AISE
</div>
<div style="text-align:center;font-weight:bold;margin-top:3mm;font-size:1.3em;">
  RAPPORT DE SAISINE
</div>
<div style="height:10mm;"></div>

      <p>L'an deux mil vingt-cinq,</p>
      <p>Le <span id="date_lettres_o">17 Juillet</span>, Ã  <span id="heure_lettres_o">16 heures et 25 minutes</span></p>
      <p>NOUS :</p>

      <p>SoussignÃ©, <span id="esr_grade_o">Grade</span> <span id="esr_nom_o">Nom</span> <span id="esr_prenom_o">PrÃ©nom</span>, <span id="esr_qualite_o">Agent de Police Judiciaire Adjoint / APJA</span>, affectÃ© Ã  la <span id="esr_affect_o">CRT 06/1 Nice</span>,</p>

      <p>AssistÃ©<span id="assist_e_o"> </span> du <span id="assist_list_o">Grade Nom PrÃ©nom, Agent de Police Judiciaire Adjoint (APJA), affectÃ© Ã  la CRT</span></p>

      <p>En fonction du Groupement de Gendarmerie DÃ©partementale des Alpes Maritimes, et dÃ©tachÃ©s pour emplois au profit de Lutte contre lâ€™Immigration IrrÃ©guliÃ¨re et Clandestine, dans le cadre du dispositif Border Force 06</p>

      <p>â€” Nous trouvant en mission de lutte contre lâ€™immigration irrÃ©guliÃ¨re et clandestine dans le dÃ©partement des Alpes-Maritimes (06) au point de passage autorisÃ© de <span id="mission_lieu_o">la Turbie</span> ce jour de <span id="mission_hdeb_o">15</span> Ã  <span id="mission_hfin_o">23</span> . â€”</p>

      <p>â€” Mis temporairement et nominativement Ã  la disposition de Monsieur le PrÃ©fet des Alpes-Maritimes, aux fins d'assurer une mission de lutte contre l'immigration irrÃ©guliÃ¨re dans le dÃ©partement des Alpes-Maritimes, â€”</p>

      <p>â€” Agissant conformÃ©ment aux instructions reÃ§ues de Madame la Commissaire Divisionnaire Emmanuelle JOUBERT, Cheffe du Service DÃ©partemental de la Police aux FrontiÃ¨res des Alpes-Maritimes, â€”</p>

      <p>â€” Vu l'article 21-1 du code de procÃ©dure pÃ©nale, â€”</p>
      <p>â€” Vu les articles 20, D13 D14 et D15 du code de procÃ©dure pÃ©nale,</p>
      <p>â€” PlacÃ©s sous l'Ã©gide de la coordination dÃ©partementale de la police aux frontiÃ¨res pour assurer la mission de contrÃ´le des points de passage frontaliers, â€”</p>
      <p>â€” Vu le titre II du rÃ¨glement (UE) 2016/399 du Parlement europÃ©en et du Conseil du 9 mars 2016 concernant un code de lâ€™Union relatif au rÃ©gime de franchissement des frontiÃ¨res par les personnes (code frontiÃ¨re Schengen) JO L 077 du 23 mars 2016, p.1. â€”</p>
      <p>â€” Vu les articles 5 Ã  8, 14 et 32 de ce rÃ¨glement. â€”</p>
      <p>â€” Vu la note des autoritÃ©s franÃ§aises notifiant au premier Vice-prÃ©sident de la commission europÃ©enne son intention, Ã  compter du 1er novembre 2025 et jusquâ€™au 30 avril 2026, de prolonger le rÃ©tablissement des contrÃ´les aux frontiÃ¨res intÃ©rieures de la France avec la Belgique, le Luxembourg, lâ€™Allemagne, lâ€™Italie, lâ€™Espagne, et la confÃ©dÃ©ration Suisse, sur le fondement des articles 25 et 27 du rÃ¨glement 2016/399 susvisÃ©. â€”</p>
      <p>â€” RevÃªtus de nos uniformes rÃ©glementaires et insignes affÃ©rents Ã  notre fonction et munis du gilet rÃ©flÃ©chissant GENDARMERIE, â€”</p>
      <div id="texte-vehicule">
      <p id="constatation_o">â€” Ã€ <span id="esi_hconstat_o">(Heure de constatation)</span>, nous constatons la prÃ©sence dâ€™un <span id="veh_type_o">(vÃ©hicule)</span> <span id="veh_marque_o">(Marque du vehicule)</span> immatriculÃ© <span id="veh_pays_o">(pays d'immatriculation)</span> sous le numÃ©ro <span id="veh_immat_o">(immatriculation)</span> en circulation et arrivant dans notre direction  â€”</p>
	  <p id="signe_o">â€” Faisons signe rÃ©glementairement <span id="conducteur_article_o">au</span> <span id="conducteur_label_o">(conducteur)</span> de stationner son vÃ©hicule correctement et en sÃ©curitÃ© <span id="lieu_controle_o">sur le parking de lâ€™aire de repos du pÃ©age de La Turbie</span>, afin de procÃ©der au contrÃ´le de lâ€™identitÃ© des passagers du vÃ©hicule. â€”</p>
      <p>â€” <span id="conducteur_article2_o">Le</span> <span id="conducteur_label2_o">conducteur</span> obtempÃ¨re Ã  notre demande, dÃ©clinons notre qualitÃ© et le motif de notre contrÃ´le. â€”</p>
	  <p id="phrase_controle_o">â€” ProcÃ©dons au contrÃ´le d'identitÃ© des personnes Ã  bord du vÃ©hicule.</p>

      <p id="piece_phrase_o">
â€” Ã€ son bord, <span id="passager_article_o">un</span> <span id="passager_label_o">passager</span>
<span id="piece_phrase_part_o">est en mesure de nous prÃ©senter un passeport</span>.
<span id="individu_phrase_o">Cet individu</span> nâ€™Ã©tant pas en mesure de nous prÃ©senter de document dâ€™identitÃ© ou de voyage en cours de validitÃ©,
<span id="passager_pronom_o">ce dernier</span> nâ€™est donc pas en rÃ¨gle pour voyager, circuler ou sÃ©journer sur le territoire national franÃ§ais. â€”
</p>
</div>
<!-- === TEXTE PIÃ‰TON (neutre complet avec identification ESI) === -->
<div id="texte-pieton" style="display:none">

  <p>â€” Ã€ <span id="heure_pieton_o">[heure]</span>, nous constatons la prÃ©sence dâ€™un individu circulant Ã  pied <span id="lieu_pieton_o">[lieu]</span> et venant dans notre direction. â€”</p>

  <p>â€” Ã€ son approche, nous dÃ©clinons notre qualitÃ© ainsi que le motif de notre contrÃ´le. â€”</p>

  <p>â€” Nous lâ€™invitons Ã  justifier de son identitÃ©, conformÃ©ment aux dispositions de lâ€™article 78-2 du Code de procÃ©dure pÃ©nale. â€”</p>

  <p id="piece_pieton_o">â€” Lâ€™intÃ©ressÃ©(e) obtempÃ¨re et est en mesure de nous prÃ©senter un document de type : <span id="piece_type_o">[piÃ¨ce d'identitÃ© prÃ©sentÃ©e]</span>. â€”</p>

</div>
      <p>â€” Il sâ€™agit de : â€”</p>

      <p id="esi_lang_phrase_o">
â€” <span id="esi_civil_o">Monsieur</span> <span id="esi_nom_o">Nom</span> <span id="esi_prenom_o">PrÃ©nom</span> nÃ©<span id="esi_nee_o"></span> le <span id="esi_dnaiss_o">(date de naissance)</span> Ã  <span id="esi_lnaiss_o">Ville de naissance</span>, de nationalitÃ© <span id="esi_nat_o">(nationalitÃ©)</span>, de sexe <span id="esi_sexe_o">masculin</span>. <span id="langue_phrase_o">Lâ€™individu sâ€™exprime en franÃ§ais approximatif.</span> <span id="identite_phrase_o">Son identitÃ© est relevÃ©e sur les piÃ¨ces prÃ©citÃ©es.</span> â€”
</p>


      <p>â€” Effectuons des recherches concernant cette personne auprÃ¨s des fichiers de Police mis Ã  notre disposition, Ã  lâ€™aide de notre tablette de service : â€”</p>
	  <p>â€” FPR : <span id="fpr_o">NÃ©gatif</span> â€”</p>
      <p>â€” AGDREF : <span id="agdref_o">NÃ©gatif</span> â€”</p>
      <p>â€”Aux fichiers Nationaux il appert quâ€™Ã  ce jour et sous cette identitÃ© : <span id="fichiers_nat_o">il a fait lâ€™objet dâ€™une OQTF</span> â€”</p>
      <p>â€” Rendons immÃ©diatement compte des faits Ã  lâ€™Officier de Police Judiciaire Territorialement CompÃ©tent de permanence du poste de la Police Aux FrontiÃ¨res de <span id="paf_ville_o1">Saint Louis Ã  Menton</span>, qui nous donne lâ€™ordre de lui prÃ©senter <span id="esi_civil2_o">Monsieur</span> <span id="esi_nom2_o">THIAM</span> <span id="esi_prenom2_o">Mamadou Moustapha</span> dans les plus brefs dÃ©lais. â€”</p>
      <p>â€” DÃ¨s lors, nous nous trouvons en prÃ©sence <span id="esi_etranger_phrase_o">dâ€™un Ã©tranger</span> en situation irrÃ©guliÃ¨re au voyage, Ã  la circulation ou au sÃ©jour sur le territoire national franÃ§ais, â€”</p>
      <p>â€” Agissant en vertu des articles L813-1 Ã  L813-16 du Code de lâ€™EntrÃ©e et du SÃ©jour des Ã‰trangers et du Droit dâ€™Asile, â€”</p>
      <p>â€” Informons la personne quâ€™elle se trouve en situation irrÃ©guliÃ¨re sur le territoire national franÃ§ais. â€”</p>
      <p>â€” Invitons <span id="esi_civil3_o">Monsieur</span> <span id="esi_nom3_o">THIAM</span> <span id="esi_prenom3_o">Mamadou Moustapha</span> Ã  nous suivre. â€”</p>
      <p>â€” <span id="palpation_text" style="white-space:pre-line; color:#000;"></span> â€”</p>
      <p>â€” <span id="transport_phrase_o">
Transportons lâ€™individu sans contrainte ni entraves au poste de la Police Aux FrontiÃ¨res de Saint Louis Ã  Menton, Ã  bord de notre vÃ©hicule de service sÃ©rigraphiÃ© Â« GENDARMERIE Â».
</span> â€”</p>
      <p>â€” PrÃ©sentons lâ€™individu devant lâ€™Officier de Police Judiciaire Territorialement CompÃ©tent de permanence du poste de la Police Aux FrontiÃ¨res de <span id="paf_ville_o3">Saint Louis Ã  Menton</span> Ã  <span id="paf_heure_o">17 heures et 10 minutes</span>. Lâ€™horaire de prÃ©sentation Ã©tant diffÃ©rÃ© eu Ã©gard au dÃ©lai de route. â€”</p>
		<p> <span id="conf_paf_text" style="white-space:pre-line; color:#000;"></span> </p>
		
		<div class="signzone">
        
        <div class="signcell">Lâ€™APJA</div>
		<div class="signcell">Lâ€™assistant</div>
      </div>
    </div>
  </div>
  
    <!-- ğŸ“ Liste des PV sauvegardÃ©s -->
  <div id="listePV" style="display:none; margin-top:30px;">
    <h3 style="color:#003366;">ğŸ“ Mes PV sauvegardÃ©s</h3>
    <div id="listePVcontenu" style="background:white;padding:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.2);"></div>
    <button class="back-btn" onclick="fermerMesPV()">â¬… Retour au PV</button>
  </div>
  <!-- ğŸ”¼ Bouton remonter en haut -->
<button id="scrollTopBtn" title="Remonter en haut" style="display:none;">
  <i class="fa-solid fa-arrow-up"></i>
</button>

</section>



<script>
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById('homePage').style.display='none';
  document.getElementById(id).classList.add('active');
}
function backHome(){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById('homePage').style.display='grid';
}
</script>

<script>
  let assistIndex = 0;
  function addAssistant(){
    assistIndex++;
    const wrap = document.getElementById('assist_list');
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <div class="row">
        <div>
          <label>Grade</label>
          <input id="a_grade_${assistIndex}" placeholder="ex: Gendarme" />
        </div>
        <div>
          <label>Nom</label>
          <input id="a_nom_${assistIndex}" 
       placeholder="NOM"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
        </div>
      </div>
      <label>PrÃ©nom</label>
      <input id="a_prenom_${assistIndex}" placeholder="PrÃ©nom" />
     <label>QualitÃ©</label>
<select id="a_qual_${assistIndex}">
  <option value="">â€” SÃ©lectionner â€”</option>
  <option value="APJA">APJA</option>
  <option value="APJ">APJ</option>
  <option value="OPJ">OPJ</option>
  <option value="AFP">AFP</option>
</select>


      <label>Affectation</label>
      <input id="a_affect_${assistIndex}" placeholder="ex: CRT 06/2 Cannes" />
      <hr style="margin:10px 0;border:none;border-top:1px dashed #ddd">`;
    wrap.appendChild(div);
  }
  // Un assistant par dÃ©faut
  addAssistant();

  function setTxt(id, v){ const el=document.getElementById(id); if(el) el.textContent = v || ''; }

  function accordAssistEsr(esrSexe, count){
    // renvoie la chaÃ®ne Ã  insÃ©rer aprÃ¨s "AssistÃ©"
    if(count>1) return 's';
    return esrSexe==='f' ? 'e' : '';
  }

  function civilFromSexe(sexe){ return sexe==='f' ? 'Madame' : 'Monsieur'; }
  function sexeLabel(sexe){ return sexe==='f' ? 'fÃ©minin' : 'masculin'; }
  function neeFromSexe(sexe){ return sexe==='f' ? 'e' : ''; }

// === Conversion automatique des abrÃ©viations de qualitÃ© ===
function qualiteLongue(code) {
  switch ((code || '').toUpperCase()) {
    case 'APJA': return 'Agent de Police Judiciaire Adjoint (APJA)';
    case 'APJ':  return 'Agent de Police Judiciaire (APJ)';
    case 'OPJ':  return 'Officier de Police Judiciaire (OPJ)';
    case 'AFP':  return 'Agent de la Force Publique (AFP)';
    default:     return code;
  }
}

  function generatePV(){
  // === Met Ã  jour le texte piÃ©ton avant gÃ©nÃ©ration ===
if (typeof majTextePieton === "function") majTextePieton();

	
  // Fonction utilitaire : convertir HH:MM en texte
function heureEnLettres(hhmm) {
  if (!hhmm) return "";
  const [h, m] = hhmm.split(":").map(Number);
  let txt = `${h} heure${h > 1 ? 's' : ''}`;
  if (m > 0) txt += ` et ${m} minute${m > 1 ? 's' : ''}`;
  return txt;
}

    // ESR
    const esr_grade = document.getElementById('esr_grade').value.trim();
    const esr_nom   = document.getElementById('esr_nom').value.trim();
    const esr_prenom= document.getElementById('esr_prenom').value.trim();
    const esr_sexe  = document.getElementById('esr_sexe').value;
    const esr_qual  = document.getElementById('esr_qualite').value.trim();
	const esr_qual_long = qualiteLongue(esr_qual);
    const esr_aff   = document.getElementById('esr_affect').value.trim();


    // Assistants
    const assistants=[];
    for(let i=1;i<=assistIndex;i++){
      const g=document.getElementById('a_grade_'+i)?.value.trim();
      const n=document.getElementById('a_nom_'+i)?.value.trim();
      const p=document.getElementById('a_prenom_'+i)?.value.trim();
      const q=document.getElementById('a_qual_'+i)?.value.trim();
      const a=document.getElementById('a_affect_'+i)?.value.trim();
      if(g&&n&&p) assistants.push({g,n,p,q,a});
    }

    // Mission
    const pv_num = document.getElementById('pv_num').value.trim();
    
    const mission_lieu = document.getElementById('mission_lieu').value.trim();
    const hdeb = document.getElementById('mission_hdeb').value.trim();
    const hfin = document.getElementById('mission_hfin').value.trim();
    const dateL = document.getElementById('date_lettres').value.trim();
    const heureL= document.getElementById('heure_lettres').value.trim();

    // ESI
    const esi_hc = document.getElementById('esi_hconstat').value.trim();
    const veh_type = document.getElementById('veh_type').value;
    const veh_immat= document.getElementById('veh_immat').value.trim();
    const lieu_ctrl = document.getElementById('lieu_controle').value.trim();
	const veh_marque = document.getElementById('veh_marque').value.trim();
    const veh_pays = document.getElementById('veh_pays').value.trim();
    const piece_id = document.getElementById('piece_id').value.trim();
	const conducteur_genre = document.getElementById('conducteur_genre').value;
    const esi_nom = document.getElementById('esi_nom').value.trim();
    const esi_prenom = document.getElementById('esi_prenom').value.trim();
    const esi_sexe = document.getElementById('esi_sexe').value;
    const esi_dnaiss = document.getElementById('esi_dnaiss').value.trim();
    const esi_lnaiss = document.getElementById('esi_lnaiss').value.trim();
    const esi_nat = document.getElementById('esi_nat').value.trim();
    const fpr = document.getElementById('fpr').value;
    const agdref = document.getElementById('agdref').value;
    const fichiersNat = document.getElementById('fichiers_nat').value.trim();
    const palp_genre = document.getElementById('palp_genre').value;
    const transport_type = document.getElementById('transport_type').value;
    const paf_ville = document.getElementById('paf_ville').value.trim();
	const paf_heure = document.getElementById('paf_heure').value.trim();

	// Conversion en lettres
const hdeb_txt = heureEnLettres(hdeb);
const hfin_txt = heureEnLettres(hfin);
const hc_txt = heureEnLettres(esi_hc);
const paf_txt = heureEnLettres(paf_heure);
const heureL_txt = heureEnLettres(heureL);

    // Remplissage colonne gauche
    setTxt('pv_num_o', pv_num);

    // Nom complet affaire / entÃªte si tu veux lâ€™afficher
    setTxt('aff_nomcomplet_o', (esi_nom+" "+esi_prenom).trim());

    // En-tÃªte centre
    setTxt('date_lettres_o', dateL);
    setTxt('heure_lettres_o', heureL_txt);

    // ESR
    setTxt('esr_grade_o', esr_grade||'');
    setTxt('esr_nom_o', esr_nom||'');
    setTxt('esr_prenom_o', esr_prenom||'');
    setTxt('esr_qualite_o', esr_qual_long || '');
    setTxt('esr_affect_o', esr_aff||'');

    // Assistants rendu
    const assistSuffix = accordAssistEsr(esr_sexe, assistants.length);
    setTxt('assist_e_o', assistSuffix); // affiche e / s / vide
   const assistTxt = assistants.length
  ? assistants.map(a=>{
      const qlong = qualiteLongue(a.q || '');
      return `${a.g} ${a.n} ${a.p}${qlong?`, ${qlong}`:''}${a.a?`, affectÃ© Ã  la ${a.a}`:''}`;
    }).join('; ')
  : 'Grade Nom PrÃ©nom, Agent de Police Judiciaire Adjoint (APJA), affectÃ© Ã  la CRT';

    setTxt('assist_list_o', assistTxt);

    // Mission
    setTxt('mission_lieu_o', mission_lieu);
    setTxt('mission_hdeb_o', hdeb_txt);
	setTxt('mission_hfin_o', hfin_txt);

    // VÃ©hicule / constatation
    setTxt('esi_hconstat_o', hc_txt);
    setTxt(
  'veh_type_o',
  veh_type.toLowerCase() === 'train'
    ? 'train'
    : veh_type.toLowerCase() === 'vl'
    ? 'vÃ©hicule lÃ©ger'
    : veh_type.toLowerCase() === 'pl'
    ? 'poids lourd'
    : veh_type.toLowerCase() === 'personne'
    ? 'individu circulant Ã  pied'
    : veh_type.toLowerCase() === 'bus'
    ? 'autobus'
    : 'vÃ©hicule'
);


    setTxt('veh_pays_o', veh_pays ? 'en ' + veh_pays : '');
    setTxt('veh_marque_o', veh_marque);
    setTxt('veh_immat_o', veh_immat);
    setTxt('lieu_controle_o', lieu_ctrl);
    setTxt('piece_id_o', piece_id);

// === Adaptation du texte selon le type de vÃ©hicule ===
(() => {
  const type = (veh_type || "").toLowerCase();

  // ğŸš¶â€â™‚ï¸ Cas piÃ©ton â†’ on ne modifie rien
  if (type === "personne") return;

  const constat = document.getElementById("constatation_o");
  const signe = document.getElementById("signe_o");
  const reponse = document.getElementById("conducteur_reponse_o");
  const controle = document.getElementById("phrase_controle_o");

  // === Cas TRAIN ===
if (type === "train") {
  // 1ï¸âƒ£ Phrase de constatation
  if (constat) {
    constat.textContent = `â€” Ã€ ${hc_txt}, nous constatons la prÃ©sence dâ€™un train ${veh_marque || ""} immatriculÃ© ${veh_pays || ""} sous le numÃ©ro ${veh_immat || ""}, en circulation et arrivant en gare dans notre direction. â€”`;
  }

  // 2ï¸âƒ£ Phrase de contact conducteur/conductrice
  if (signe) {
    const article = document.getElementById("conducteur_article_o")?.textContent?.trim() || "au";
    const label = document.getElementById("conducteur_label_o")?.textContent?.trim() || "conducteur";
    signe.innerHTML = `â€” Ã€ lâ€™arrÃªt du train, faisons signe <span id="conducteur_article_o">${document.getElementById("conducteur_article_o")?.textContent || "au"}</span> <span id="conducteur_label_o">${document.getElementById("conducteur_label_o")?.textContent || "conducteur"}</span> afin de lui indiquer que nous allons procÃ©der Ã  un contrÃ´le. â€”`;
  }

  // 3ï¸âƒ£ Phrase dâ€™obtempÃ©ration (adaptÃ©e au genre)
  if (reponse) {
    const article2 = document.getElementById("conducteur_article2_o")?.textContent?.trim() || "Le";
    const label2 = document.getElementById("conducteur_label2_o")?.textContent?.trim() || "conducteur";
    reponse.innerHTML = `â€” ${article2} ${label2} obtempÃ¨re Ã  notre demande, nous dÃ©clinons notre qualitÃ© et le motif de notre contrÃ´le. â€”`;
  }

  // 4ï¸âƒ£ Phrase de contrÃ´le
  if (controle) {
    controle.textContent = "â€” ProcÃ©dons au contrÃ´le dâ€™identitÃ© des passagers Ã  bord du train. â€”";
  }

  return;
}


  // === ğŸ”¹ CAS BUS / VL / PL / AUTRE ===
  const texteConstatStd = `â€” Ã€ ${hc_txt}, nous constatons la prÃ©sence dâ€™un ${type === "vl" ? "vÃ©hicule lÃ©ger" : type === "pl" ? "poids lourd" : type === "bus" ? "autobus" : "vÃ©hicule"} ${veh_marque || ""} immatriculÃ© ${veh_pays ? " " + veh_pays : ""} sous le numÃ©ro ${veh_immat || ""} en circulation et arrivant dans notre direction. â€”`;
  if (constat) constat.textContent = texteConstatStd;

  // ğŸ§© Ici on garde les spans dynamiques pour les accords de genre
  if (signe) {
    let lieu = lieu_ctrl || "sur le bas-cÃ´tÃ©";
    if (type === "bus") lieu = lieu_ctrl || "sur le quai de la gare";

    signe.innerHTML = `â€” Faisons signe rÃ©glementairement <span id="conducteur_article_o">${document.getElementById("conducteur_article_o")?.textContent || "au"}</span> <span id="conducteur_label_o">${document.getElementById("conducteur_label_o")?.textContent || "conducteur"}</span> de stationner son vÃ©hicule correctement et en sÃ©curitÃ© ${lieu}, afin de procÃ©der au contrÃ´le de lâ€™identitÃ© des passagers du vÃ©hicule. â€”`;
  }

  if (reponse) {
    reponse.innerHTML = `â€” <span id="conducteur_article2_o">${document.getElementById("conducteur_article2_o")?.textContent || "Le"}</span> <span id="conducteur_label2_o">${document.getElementById("conducteur_label2_o")?.textContent || "conducteur"}</span> obtempÃ¨re Ã  notre demande, dÃ©clinons notre qualitÃ© et le motif de notre contrÃ´le. â€”`;
  }

  if (controle) {
    let phrase = "";
    switch (type) {
      case "bus":
        phrase = "â€” ProcÃ©dons au contrÃ´le dâ€™identitÃ© des passagers Ã  bord du bus. â€”";
        break;
      case "vl":
        phrase = "â€” ProcÃ©dons au contrÃ´le dâ€™identitÃ© des passagers Ã  bord du vÃ©hicule lÃ©ger. â€”";
        break;
      case "pl":
        phrase = "â€” ProcÃ©dons au contrÃ´le dâ€™identitÃ© des passagers Ã  bord du poids lourd. â€”";
        break;
      default:
        phrase = "â€” ProcÃ©dons au contrÃ´le dâ€™identitÃ© des passagers Ã  bord du vÃ©hicule. â€”";
    }
    controle.textContent = phrase;
  }
})();


// Accord conducteur / conductrice
if (conducteur_genre === 'f') {
  setTxt('conducteur_article_o', 'Ã  la');
  setTxt('conducteur_label_o', 'conductrice');
} else {
  setTxt('conducteur_article_o', 'au');
  setTxt('conducteur_label_o', 'conducteur');
}
// DeuxiÃ¨me accord (Le conducteur / La conductrice)
if (conducteur_genre === 'f') {
  setTxt('conducteur_article2_o', 'La');
  setTxt('conducteur_label2_o', 'conductrice');
} else {
  setTxt('conducteur_article2_o', 'Le');
  setTxt('conducteur_label2_o', 'conducteur');
}

    // IdentitÃ© ESI
    const civil = civilFromSexe(esi_sexe);
    const nee = neeFromSexe(esi_sexe);
    setTxt('esi_civil_o', civil);
	setTxt('esi_civil_left_o', civil);
    setTxt('esi_nom_o', esi_nom);
    setTxt('esi_prenom_o', esi_prenom);
    setTxt('esi_nee_o', nee);
    setTxt('esi_dnaiss_o', esi_dnaiss);
    setTxt('esi_lnaiss_o', esi_lnaiss);
    setTxt('esi_nat_o', esi_nat);
    setTxt('esi_sexe_o', sexeLabel(esi_sexe));


    // Fichiers
    setTxt('fpr_o', fpr);
    setTxt('agdref_o', agdref);
    setTxt('fichiers_nat_o', fichiersNat);

    // PAF / suites
    setTxt('paf_ville_o1', paf_ville);
    setTxt('paf_ville_o2', paf_ville);
    setTxt('paf_ville_o3', paf_ville);

    // Suites â€“ civilitÃ©s rÃ©pÃ©tÃ©es
    setTxt('esi_civil2_o', civil);
    setTxt('esi_nom2_o', esi_nom);
    setTxt('esi_prenom2_o', esi_prenom);

    setTxt('esi_civil3_o', civil);
    setTxt('esi_nom3_o', esi_nom);
    setTxt('esi_prenom3_o', esi_prenom);

  // === PALPATION & TRANSPORT ===
setTxt('palp_genre_o', 
  palp_genre === 'f' ? 'fÃ©minin' :
  palp_genre === 'm' ? 'masculin' :
  palp_genre === 'impossible' ? 'impossible' : ''
);

// === PALPATION & TRANSPORT ===
setTxt('palp_genre_o', 
  palp_genre === 'f' ? 'fÃ©minin' :
  palp_genre === 'm' ? 'masculin' :
  palp_genre === 'impossible' ? 'impossible' : ''
);



    // Phrase de transport selon le type choisi
let phraseTransport = '';
if (transport_type === 'GENDARMERIE') {
  phraseTransport = `Transportons lâ€™individu sans contrainte ni entraves au poste de la Police Aux FrontiÃ¨res de ${paf_ville}, Ã  bord de notre vÃ©hicule de service sÃ©rigraphiÃ© Â« GENDARMERIE Â».`;
} else {
  phraseTransport = `Transportons lâ€™individu sans contrainte ni entraves au poste de la Police Aux FrontiÃ¨res de ${paf_ville}, Ã  bord de notre vÃ©hicule de service de translation mis Ã  disposition par la Police Nationale.`;
}
setTxt('transport_phrase_o', phraseTransport);
setTxt('paf_heure_o', paf_txt);
// Accord passager / pronom selon le sexe de l'ESI
if (esi_sexe === 'f') {
  setTxt('passager_article_o', 'une');
  setTxt('passager_label_o', 'passagÃ¨re');
  setTxt('individu_phrase_o', 'Cet individu'); // reste neutre administratif
  setTxt('passager_pronom_o', 'cette derniÃ¨re');
} else {
  setTxt('passager_article_o', 'un');
  setTxt('passager_label_o', 'passager');
  setTxt('individu_phrase_o', 'Cet individu');
  setTxt('passager_pronom_o', 'ce dernier');
}

// === Phrase dynamique selon la piÃ¨ce dâ€™identitÃ© ===
(() => {
  const pieceInput = document.getElementById('piece_id');
  const target = document.getElementById('piece_phrase_part_o');
  if (!pieceInput || !target) {
    console.warn("âš ï¸ Ã‰lÃ©ment manquant pour la phrase d'identitÃ©.");
    return;
  }

  const piece_id = pieceInput.value.trim();
  const phrase = piece_id
    ? `est en mesure de nous prÃ©senter une piÃ¨ce d'identitÃ© de type: ${piece_id}`
    : `nâ€™est pas en mesure de nous prÃ©senter un document pouvant justifier de son identitÃ©`;
  
  target.textContent = phrase;
})();

// === Langue parlÃ©e et relevÃ© d'identitÃ© ===
(() => {
  const langueSelect = document.getElementById('esi_langue');
  const pieceInput = document.getElementById('piece_id');
  const langueSpan = document.getElementById('langue_phrase_o');
  const identiteSpan = document.getElementById('identite_phrase_o');

  if (!langueSelect || !langueSpan || !identiteSpan) {
    console.warn("âš ï¸ Ã‰lÃ©ment manquant pour la langue ou l'identitÃ©.");
    return;
  }

  const langue = langueSelect.value;
  const pieceTxt = pieceInput ? pieceInput.value.trim() : '';

  // Phrase sur la langue
  let languePhrase = '';
  if (langue === 'fr_ok') {
    languePhrase = "Lâ€™individu parle franÃ§ais.";
  } else if (langue === 'fr_approx') {
    languePhrase = "Lâ€™individu sâ€™exprime en franÃ§ais approximatif.";
  } else if (langue === 'npf') {
    languePhrase = "Lâ€™individu ne parle pas franÃ§ais.";
  }

  // Phrase sur le relevÃ© d'identitÃ©
  let identitePhrase = '';
  if (pieceTxt) {
    identitePhrase = "Son identitÃ© est relevÃ©e sur les piÃ¨ces prÃ©citÃ©es.";
  } else {
    identitePhrase = "Son identitÃ© est relevÃ©e sur sa dÃ©claration verbale.";
  }

  // Injection dans le PV
  langueSpan.textContent = languePhrase;
  identiteSpan.textContent = identitePhrase;
})();

// Accord pour "Ã©tranger / Ã©trangÃ¨re"
(() => {
  const target = document.getElementById('esi_etranger_phrase_o');
  if (!target) return;
  target.textContent = esi_sexe === 'f' ? "dâ€™une Ã©trangÃ¨re" : "dâ€™un Ã©tranger";
})();


  /*  // Affiche la feuille
    document.getElementById('sheet').style.display='grid';
    // Scroll vers la feuille pour aperÃ§u
    document.getElementById('sheet').scrollIntoView({behavior:'smooth',block:'start'});
  }*/
  const sheet = document.getElementById('sheet');
if (sheet) {
  sheet.style.display = 'grid';
  sheet.style.margin = '30px auto';
  sheet.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// âœ… Affiche les boutons liÃ©s Ã  lâ€™affichage du PV
const closeBtn = document.getElementById("closePVBtn");
if (closeBtn) closeBtn.style.display = "inline-block";

const scrollBtn = document.getElementById("scrollTopBtn");
if (scrollBtn) scrollBtn.style.display = "block";

majPalpation();
}

 function openPrintPreview() {
  // On gÃ©nÃ¨re / met Ã  jour le PV
  try {
    generatePV();
  } catch (e) {
    console.error("Erreur generatePV:", e);
    if (typeof showToast === 'function') {
      showToast("Erreur lors de la gÃ©nÃ©ration du PV");
    } else {
      alert("Erreur lors de la gÃ©nÃ©ration du PV");
    }
    return;
  }

  const sheet = document.getElementById('sheet');
  if (!sheet) {
    if (typeof showToast === 'function') {
      showToast("Zone PV introuvable (#sheet)");
    } else {
      alert("Zone PV introuvable (#sheet)");
    }
    return;
  }

  // S'assurer que le PV est visible avant impression
  sheet.style.display = 'grid';
  sheet.style.margin = '30px auto';

  // Petit dÃ©lai pour laisser le DOM appliquer les changements
  setTimeout(() => {
    window.print(); // ğŸ‘‰ ouvre l'impression native (dont PDF sur Chrome)
  }, 200);
}


// === ğŸ’¾ SAUVEGARDE AUTOMATIQUE AVEC DEBOUNCE (inclut les assistants dynamiques) ===
let saveTimeout;

// Fonction principale de sauvegarde
function savePV() {
  const data = {};

  // Champs fixes
  const champsFixes = [
    'esr_grade','esr_nom','esr_prenom','esr_sexe','esr_qualite','esr_affect',
    'pv_num','mission_lieu','mission_hdeb','mission_hfin',
    'date_lettres','heure_lettres','esi_hconstat','veh_type','veh_marque',
    'veh_immat','veh_pays','conducteur_genre','lieu_controle','piece_id',
    'esi_nom','esi_prenom','esi_sexe','esi_dnaiss','esi_lnaiss','esi_nat',
    'esi_langue','fpr','agdref','fichiers_nat','palp_genre','objets_trouves','transport_type',
    'paf_ville','paf_heure'
  ];

  champsFixes.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });
 // âœ… Ajout des champs PIÃ‰TON (issus du texte gÃ©nÃ©rÃ©)
  const heurePieton = document.getElementById('heure_pieton_o')?.textContent || '';
  const lieuPieton  = document.getElementById('lieu_pieton_o')?.textContent || '';
  const pieceType   = document.getElementById('piece_type_o')?.textContent || '';
   data.heure_pieton = heurePieton;
  data.lieu_pieton  = lieuPieton;
  data.piece_type   = pieceType;
  
  // Champs dynamiques (assistants)
  const assistants = [];
  document.querySelectorAll('#assist_list > div').forEach((div, index) => {
    const a = {
      grade: div.querySelector(`[id^="a_grade_"]`)?.value || '',
      nom: div.querySelector(`[id^="a_nom_"]`)?.value || '',
      prenom: div.querySelector(`[id^="a_prenom_"]`)?.value || '',
      qualite: div.querySelector(`[id^="a_qual_"]`)?.value || '',
      affect: div.querySelector(`[id^="a_affect_"]`)?.value || ''
    };
    assistants.push(a);
  });
  data.assistants = assistants;

  // Sauvegarde dans le localStorage
  localStorage.setItem('pv_interpellation_data', JSON.stringify(data));
  console.log("âœ… PV sauvegardÃ© automatiquement");
}

// Fonction debounce (attend 3 secondes aprÃ¨s la derniÃ¨re saisie)
function debounceSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(savePV, 3000);
}

// Attache lâ€™Ã©couteur Ã  tous les champs existants
function attachListeners() {
  document.querySelectorAll('input, select, textarea').forEach(el => {
    el.removeEventListener('input', debounceSave);
    el.addEventListener('input', debounceSave);
  });
}
attachListeners();

// === RECHARGEMENT AUTOMATIQUE DES DONNÃ‰ES ===
window.addEventListener('load', () => {
  const saved = localStorage.getItem('pv_interpellation_data');
  if (!saved) return;
  try {
    const data = JSON.parse(saved);

    // Champs fixes
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (el && typeof data[id] === 'string') el.value = data[id];
    });

    // Assistants dynamiques
    if (Array.isArray(data.assistants) && data.assistants.length > 0) {
      document.getElementById('assist_list').innerHTML = ''; // Nettoyage avant recharge
      assistIndex = 0;
      data.assistants.forEach(a => {
        addAssistant();
        const div = document.querySelector(`#assist_list > div:last-child`);
        div.querySelector(`[id^="a_grade_"]`).value = a.grade;
        div.querySelector(`[id^="a_nom_"]`).value = a.nom;
        div.querySelector(`[id^="a_prenom_"]`).value = a.prenom;
        div.querySelector(`[id^="a_qual_"]`).value = a.qualite;
        div.querySelector(`[id^="a_affect_"]`).value = a.affect;
      });
    }
	// âœ… Restauration des champs piÃ©ton sâ€™ils existent
if (data.heure_pieton && document.getElementById('heure_pieton_o')) {
  document.getElementById('heure_pieton_o').textContent = data.heure_pieton;
}
if (data.lieu_pieton && document.getElementById('lieu_pieton_o')) {
  document.getElementById('lieu_pieton_o').textContent = data.lieu_pieton;
}
if (data.piece_type && document.getElementById('piece_type_o')) {
  document.getElementById('piece_type_o').textContent = data.piece_type;
}

// âœ… Recalcule affichage piÃ©ton si sÃ©lectionnÃ©
if (typeof majAffichageType === "function") majAffichageType();
if (typeof majTextePieton === "function") majTextePieton();

   console.log("â™»ï¸ PV restaurÃ© avec les assistants sauvegardÃ©s");

  } catch(e) {
    console.error('Erreur chargement PV sauvegardÃ©', e);
	
  }
});

// === GESTION MULTI-PV ===
let pvCourantId = null; // identifiant du PV en cours d'Ã©dition

// ğŸ”¹ Sauvegarde manuelle (version compatible sandbox + notification)
function sauvegarderPV() {
  const data = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    if (el.id) data[el.id] = el.value;
  });

  const nomESI = (document.getElementById('esi_nom')?.value || "Inconnu").trim();
  const dateMission = (document.getElementById('date_lettres')?.value || "Date ?").trim();

  let list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  let id = pvCourantId || Date.now();

  const index = list.findIndex(pv => String(pv.id) === String(id));
  const newPV = { id, nomESI, dateMission, data };

  if (index >= 0) {
    list[index] = newPV;
    showToast("ğŸ”„ PV mis Ã  jour");
  } else {
    list.push(newPV);
    showToast("âœ… PV sauvegardÃ©");
  }

  pvCourantId = id;
  localStorage.setItem('pv_list', JSON.stringify(list));
}



// ğŸ”¹ Affichage de la page "Mes PV"
function ouvrirMesPV() {
  const listePV = document.getElementById('listePV');
  const contenu = document.getElementById('listePVcontenu');
  const sheet = document.getElementById('sheet');

  if (!listePV || !contenu) {
    alert("Erreur : la zone listePV n'existe pas.");
    return;
  }

  // Masque le PV
  if (sheet) sheet.style.display = 'none';

  // Vide et recharge la liste
  contenu.innerHTML = '';

  // RÃ©cupÃ¨re les PV enregistrÃ©s
  const pvList = JSON.parse(localStorage.getItem('pv_list') || '[]');

  if (pvList.length === 0) {
    contenu.innerHTML = "<p>Aucun PV sauvegardÃ©.</p>";
  } else {
    pvList.forEach((pv, i) => {
      const div = document.createElement('div');
      div.style.borderBottom = "1px solid #ccc";
      div.style.padding = "8px 0";
     div.innerHTML = `
  <strong>${pv.nomESI || 'Sans nom'}</strong><br>
  <small>${pv.dateMission || ''}</small><br>
  <button onclick="chargerPV(${pv.id})">âœï¸ Modifier</button>
  <button onclick="supprimerPV(${pv.id})" style="color:red;">ğŸ—‘ï¸ Supprimer</button>
`;

      contenu.appendChild(div);
    });
  }

  listePV.style.display = 'block';
}

function fermerMesPV() {
  const listePV = document.getElementById('listePV');
  const sheet = document.getElementById('sheet');
  const closeBtn = document.getElementById('closePVBtn'); // âœ… ton bouton Fermer

  // ğŸ”¹ On cache la liste des PV
  if (listePV) listePV.style.display = 'none';

  // ğŸ”¹ On rÃ©affiche le PV avec sa mise en page dâ€™origine
  if (sheet) {
    sheet.style.display = 'grid'; // âœ… garde la mise en forme correcte
    sheet.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // ğŸ”¹ On rend visible le bouton Fermer
  if (closeBtn) closeBtn.style.display = 'inline-block';
  const scrollBtn = document.getElementById("scrollTopBtn");
if (scrollBtn) scrollBtn.style.display = "block"; // âœ… rÃ©affiche quand retour PV
}

function chargerPV(id) {
  const list = JSON.parse(localStorage.getItem('pv_list') || "[]");

  // ğŸ” on compare en string pour Ãªtre sÃ»r (Ã©vite les bugs number/string)
  const pv = list.find(p => String(p.id) === String(id));

  if (!pv) {
    showToast("PV introuvable");
    return;
  }

  // â™»ï¸ RÃ©injecte toutes les donnÃ©es dans les champs
  if (pv.data && typeof pv.data === 'object') {
    Object.keys(pv.data).forEach(k => {
      const el = document.getElementById(k);
      if (el) el.value = pv.data[k];
    });
  }

  // ğŸ†” On mÃ©morise l'ID du PV chargÃ© pour le prochain sauvegarderPV()
  pvCourantId = pv.id;

  // ğŸ”™ On ferme la liste et revient sur le PV
  fermerMesPV();

  // âœ… Petit message non bloquant
  showToast("PV chargÃ©");

  // ğŸ”¼ Remonte en haut + rÃ©gÃ©nÃ¨re le PV avec les nouvelles valeurs
  window.scrollTo({ top: 0, behavior: 'smooth' });
  generatePV();
}


function supprimerPV(id) {
  // En sandbox, confirm() est bloquÃ© â†’ on supprime directement
  let list = JSON.parse(localStorage.getItem('pv_list') || "[]");

  list = list.filter(pv => String(pv.id) !== String(id));

  localStorage.setItem('pv_list', JSON.stringify(list));
  ouvrirMesPV();
  showToast("PV supprimÃ©");
}

function nouveauPV() {
  // On repart sur un NOUVEAU PV
  if (typeof pvCourantId !== 'undefined') {
    pvCourantId = null;
  }

  // Champs Ã  prÃ©server (ESR / rÃ©dacteur + nÂ° PV)
  const preserve = new Set([
    'esr_grade',
    'esr_nom',
    'esr_prenom',
    'esr_sexe',
    'esr_qualite',
    'esr_affect',
    'pv_num'
  ]);

  // Efface tous les champs sauf ceux du rÃ©dacteur
  document.querySelectorAll('input, select, textarea').forEach(el => {
    if (!el.id) return;
    if (preserve.has(el.id)) return;

    if (el.tagName === 'SELECT') {
      el.selectedIndex = 0;
    } else {
      el.value = '';
    }
  });

  // RÃ©initialise les assistants : 1 bloc propre
  const assistList = document.getElementById('assist_list');
  if (assistList) {
    assistList.innerHTML = '';
  }
  if (typeof assistIndex !== 'undefined') {
    assistIndex = 0;
  }
  if (typeof addAssistant === 'function') {
    addAssistant();
  }

  // Cache la liste "Mes PV" si ouverte
  const listePV = document.getElementById('listePV');
  if (listePV) {
    listePV.style.display = 'none';
  }

  // Cache la feuille PV gÃ©nÃ©rÃ©e
  const sheet = document.getElementById('sheet');
  if (sheet) {
    sheet.style.display = 'none';
  }

  // Nettoie le brouillon auto-sauvegardÃ©
  localStorage.removeItem('pv_interpellation_data');

  // Indication visuelle (au lieu de alert, compatible sandbox)
  if (typeof showToast === 'function') {
    showToast("Nouveau PV vierge prÃªt");
  }

  // Remonte en haut
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

 
</script>

<script>
// === Texte piÃ©ton neutre et complet (avec identification automatique) ===
(function(){
  function majTextePieton(){
    const veh = (document.getElementById("veh_type")?.value || "").toLowerCase();
    if (veh !== "personne") return; // uniquement si piÃ©ton

    // Champs du formulaire
    const heure = document.getElementById("esi_hconstat")?.value || "[heure de constatation]";
    const lieu  = document.getElementById("lieu_controle")?.value || "[lieu du contrÃ´le]";
    const piece = (document.getElementById("piece_id")?.value ?? "").trim();

    const nom    = document.getElementById("esi_nom")?.value || "[NOM]";
    const prenom = document.getElementById("esi_prenom")?.value || "[PrÃ©nom]";
    const naissance = document.getElementById("esi_dnaiss")?.value || "[date de naissance]";
    const lieuNais  = document.getElementById("esi_lnaiss")?.value || "[lieu de naissance]";
    const nationalite = document.getElementById("esi_nat")?.value || "[nationalitÃ©]";
    const sexe = (document.getElementById("esi_sexe")?.value || "").toLowerCase();

    // RÃ©cupÃ©ration des zones de texte dans le PV
    const spanHeure = document.getElementById("heure_pieton_o");
    const spanLieu  = document.getElementById("lieu_pieton_o");
    const phrasePiece = document.getElementById("piece_pieton_o");
    const pieceSpan = document.getElementById("piece_type_o");
    const identiteBloc = document.getElementById("identite_pieton_o");
    const sourceIdentite = document.getElementById("source_identite_o");

    // Remplissage heure/lieu
    if (spanHeure) spanHeure.textContent = heure;
    if (spanLieu)  spanLieu.textContent  = lieu;

    // Accord de "L'intÃ©ressÃ©(e)"
    const interesse = (sexe === "f") ? "Lâ€™intÃ©ressÃ©e" : "Lâ€™intÃ©ressÃ©";

    // Phrase sur la piÃ¨ce d'identitÃ©
    if (phrasePiece) {
      if (piece) {
        phrasePiece.innerHTML =
          "â€” " + interesse + " obtempÃ¨re et est en mesure de nous prÃ©senter un document de type : " +
          "<span id=\"piece_type_o\">" + piece + "</span>. â€”";
      } else {
        phrasePiece.innerHTML =
          "â€” " + interesse + " nâ€™est pas en mesure de nous prÃ©senter de document permettant de justifier de son identitÃ©. â€”";
      }
    }

    // Bloc identitÃ© piÃ©ton
    if (identiteBloc) {
      identiteBloc.innerHTML =
        "â€” " + (sexe === "f" ? "Madame " : "Monsieur ") + nom + " " + prenom +
        " nÃ©" + (sexe === "f" ? "e" : "") + " le " + naissance +
        ", Ã  " + lieuNais +
        ", de nationalitÃ© " + nationalite +
        ", de sexe " + (sexe === "f" ? "fÃ©minin" : "masculin") +
        ". Lâ€™individu parle franÃ§ais. <span id='source_identite_o'>" +
        (piece ? "Son identitÃ© est relevÃ©e sur les piÃ¨ces prÃ©citÃ©es." : "selon sa dÃ©claration verbale.") +
        "</span> â€”";
    }
  }

  // Mets Ã  jour Ã  chaque changement des champs
  document.addEventListener("change", (e)=>{
    if([
      "veh_type","esi_hconstat","lieu_controle","piece_id",
      "esi_nom","esi_prenom","esi_dnaiss","esi_lnaiss","esi_nat","esi_sexe"
    ].includes(e.target.id)){
      majTextePieton();
    }
  });

  document.addEventListener("DOMContentLoaded", majTextePieton);
})();

</script>
<script>
(function () {
  function majAffichageType() {
    const veh = document.getElementById("texte-vehicule");
    const pie = document.getElementById("texte-pieton");
    const sel = document.getElementById("veh_type");

    if (!sel || !veh || !pie) {
      console.warn("Bascule: Ã©lÃ©ment manquant",
        { sel: !!sel, veh: !!veh, pie: !!pie });
      return;
    }

    const v = (sel.value || "").toLowerCase();
    // bascule affichage
    if (v === "personne") {
      veh.style.display = "none";
      pie.style.display = "block";
    } else {
      veh.style.display = "block";
      pie.style.display = "none";
    }
  }

  function bindBascule() {
    const sel = document.getElementById("veh_type");
    if (sel && !sel._pietonBound) {
      sel.addEventListener("change", majAffichageType);
      sel._pietonBound = true;
    }
    // applique l'Ã©tat actuel (utile au rechargement)
    majAffichageType();
  }

  // 1) Quand le DOM est prÃªt
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindBascule);
  } else {
    bindBascule();
  }

  // 2) AprÃ¨s ta gÃ©nÃ©ration PV (si elle existe), on rÃ©applique la bascule
  if (typeof window.generatePV === "function" && !window._wrapGenPV_forPieton) {
    const orig = window.generatePV;
    window.generatePV = function () {
      const out = orig.apply(this, arguments);
      try { majAffichageType(); } catch (e) {}
      return out;
    };
    window._wrapGenPV_forPieton = true;
  }
})();
</script>
<script>
// === MISE Ã€ JOUR DES SIGNATURES ET TITRES SELON QUALITÃ‰ ET NOMBRE Dâ€™ASSISTANTS ===
function majSignaturesEtTitres() {
  const qualite = (document.getElementById("esr_qualite")?.value || "").trim();
  const assistants = document.querySelectorAll('#assist_list > div').length;

  // === COLONNE DE GAUCHE ===
  const colonneGauche = document.getElementById("sign_col_g");
  if (colonneGauche) {
    // Texte qualitÃ© abrÃ©gÃ©e (haut du PV)
    let qualiteCourte = "Le rÃ©dacteur";
    if (qualite.match(/opj/i)) qualiteCourte = "Lâ€™OPJ";
    else if (qualite.match(/apja/i)) qualiteCourte = "Lâ€™APJA";
    else if (qualite.match(/apj/i)) qualiteCourte = "Lâ€™APJ";

    // Texte assistants
    const assistantsTexte = assistants > 1 ? "Les assistants" : "Lâ€™assistant";

    // Injection
    colonneGauche.textContent = `${qualiteCourte}               ${assistantsTexte}`;
  }

  // === SIGNATURE EN BAS ===
  const celluleRedacteur = document.querySelector('.signzone .signcell:first-child');
  const celluleAssistants = document.querySelector('.signzone .signcell:last-child');

  if (celluleRedacteur) {
    // Texte complet de la qualitÃ© pour signature
    let qualiteLongue = "Le rÃ©dacteur";
    if (qualite.match(/opj/i)) qualiteLongue = "Lâ€™Officier de Police Judiciaire";
    else if (qualite.match(/apja/i)) qualiteLongue = "Lâ€™Agent de Police Judiciaire Adjoint";
    else if (qualite.match(/apj/i)) qualiteLongue = "Lâ€™Agent de Police Judiciaire";

    celluleRedacteur.textContent = qualiteLongue;
  }

  if (celluleAssistants) {
    const assistantsTexte = assistants > 1 ? "Les assistants" : "Lâ€™assistant";
    celluleAssistants.textContent = assistantsTexte;
  }
}

// ExÃ©cution automatique Ã  chaque changement de qualitÃ© ou dâ€™assistants
document.addEventListener("input", e => {
  if (["esr_qualite"].includes(e.target.id)) majSignaturesEtTitres();
});
document.addEventListener("click", e => {
  if (e.target.matches(".btn-add-assistant, .btn-remove-assistant")) {
    setTimeout(majSignaturesEtTitres, 100);
  }
});

// ExÃ©cution au chargement et Ã  chaque gÃ©nÃ©ration de PV
window.addEventListener("load", majSignaturesEtTitres);
if (typeof generatePV === "function" && !window._signaturesBound) {
  const orig = generatePV;
  window.generatePV = function () {
    const out = orig.apply(this, arguments);
    try { majSignaturesEtTitres(); } catch(e) {}
    return out;
  };
  window._signaturesBound = true;
}

</script>
<script>
document.getElementById('sendMailBtn').addEventListener('click', () => {
  // ğŸ”¹ RÃ©cupÃ©ration des infos du PV
  const nomESI = document.getElementById('esi_nom')?.value.trim() || "ESI";
  const date = document.getElementById('date_lettres')?.value.trim() || "Date";

  // ğŸ”¹ RÃ©cupÃ©ration des infos du rÃ©dacteur
  const grade = document.getElementById('esr_grade')?.value.trim() || "";
  const nomRedacteur = document.getElementById('esr_nom')?.value.trim().toUpperCase() || "";
  const prenom = document.getElementById('esr_prenom')?.value.trim() || "";
  const affect = document.getElementById('esr_affect')?.value.trim() || "";

  // ğŸ”¹ Adresse mail laissÃ©e vide (utilisateur choisit le destinataire)
  const destinataire = "";

  // ğŸ”¹ CrÃ©ation de la signature formatÃ©e
  let signature = "Cordialement,\n\n";
  if (grade || nomRedacteur) {
    signature += `${grade} ${nomRedacteur}`;
    if (prenom) signature += ` ${prenom}`;
    signature += "\n";
  }
  if (affect) signature += `${affect}\n`;
  signature += "Border Force 06\n";

  // ğŸ”¹ Objet et corps du message
  const subject = encodeURIComponent(`Transmission du PV - ${nomESI} (${date})`);
  const body = encodeURIComponent(
    "Bonjour,\n\n" +
    "Veuillez trouver ci-joint le procÃ¨s-verbal gÃ©nÃ©rÃ© et enregistrÃ© depuis lâ€™application Border Force / App PV.\n\n" +
    "ğŸ“ SÃ©lectionnez le fichier PDF que vous avez enregistrÃ© prÃ©cÃ©demment (dans le dossier TÃ©lÃ©chargements ou Documents de votre appareil).\n\n" +
    signature
  );

  // ğŸ”¹ Ouvre la messagerie avec les champs prÃ©remplis
  window.location.href = `mailto:${destinataire}?subject=${subject}&body=${body}`;
});
</script>
<script>
// === Menu dÃ©roulant Options ===
document.getElementById('toggleOptions').addEventListener('click', () => {
  const menu = document.getElementById('optionsMenu');
  menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'flex' : 'none';
});
</script>
<script>
function majPalpation() {
  const zonePalp = document.getElementById("palpation_text");
  const zoneConf = document.getElementById("conf_paf_text");
  if (!zonePalp) return;

  const palpGenre = (document.getElementById("palp_genre")?.value || "").toLowerCase();
  const esiSexe   = (document.getElementById("esi_sexe")?.value || "").toLowerCase();
  const objets    = (document.getElementById("objets_trouves")?.value || "").trim();

  let texte = "";
  let texteConf = "";

  if (palpGenre === "impossible") {
    texte = "La palpation de sÃ©curitÃ© nâ€™a pas pu Ãªtre rÃ©alisÃ©e sur place Ã  dÃ©faut de personnel du mÃªme sexe.";
  } 
  else if (palpGenre === "m" || palpGenre === "f") {
    const personnel = palpGenre === "m" ? "personnel masculin" : "personnel fÃ©minin";

    // Gestion sÃ©curisÃ©e du genre de lâ€™ESI
    let debut, pronom, e, porteur;
    if (esiSexe.startsWith("f")) {
      debut = "PalpÃ©e";
      pronom = "elle";
      e = "e";
      porteur = "porteuse";
    } else if (esiSexe.startsWith("m")) {
      debut = "PalpÃ©";
      pronom = "il";
      e = "";
      porteur = "porteur";
    } else {
      // Cas neutre (si sexe non renseignÃ©) 
      debut = "PalpÃ©(e)";
      pronom = "la personne";
      e = "";
      porteur = "porteuse/porteur";
    }

    if (!objets) {
      texte = `${debut} par mesure de sÃ©curitÃ©, par un ${personnel}, ${pronom} nâ€™est trouvÃ©${e} ${porteur} dâ€™aucun objet dangereux pour autrui ou pour ${pronom === "elle" ? "elle-mÃªme" : pronom === "il" ? "lui-mÃªme" : "elle/lui-mÃªme"}.`;
    } 
    else {
      const liste = objets.split(/[,;]+/).map(x => x.trim()).filter(Boolean);
      const pluriel = liste.length > 1;
      const objetsTxt = liste.join(", ");
      const motObjet = pluriel ? "objets" : "objet";
      const suivants = pluriel ? "suivants" : "suivant";
      const deDes = pluriel ? "des" : "de lâ€™";
      const ceCes = pluriel ? "Ces" : "Cet";
      const ont = pluriel ? "sont" : "est";
      const confisques = pluriel ? "confisquÃ©s" : "confisquÃ©";
      const confies = pluriel ? "confiÃ©s" : "confiÃ©";
      const lesOuL = pluriel ? "Les" : "Lâ€™";

      // Phrase principale
      texte = `${debut} par mesure de sÃ©curitÃ©, par un ${personnel}, ${pronom} est trouvÃ©${e} ${porteur} ${deDes} ${motObjet} ${suivants} : ${objetsTxt}. `
            + `${ceCes} ${motObjet} ${ont} ${confisques} pendant le transport.`;

      // Phrase finale dÃ©placÃ©e Ã  la fin du PV
      texteConf = `â€” ${lesOuL} ${motObjet} ${confisques} ${ont} ${confies} au personnel de la Police aux FrontiÃ¨res. â€” `;
    }
  }

  zonePalp.textContent = texte;
  if (zoneConf) zoneConf.textContent = texteConf;
}


</script>
<script>
function formatDateNaissance(input) {
  let v = input.value.replace(/\D/g, ""); // supprime tout sauf les chiffres
  if (v.length >= 5) {
    input.value = v.slice(0, 2) + "/" + v.slice(2, 4) + "/" + v.slice(4, 8);
  } else if (v.length >= 3) {
    input.value = v.slice(0, 2) + "/" + v.slice(2, 4);
  } else {
    input.value = v;
  }
}
</script>
<script>
// Fonction pour remonter en haut de la page
function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'  // ğŸ‘ˆ dÃ©filement fluide
  });
}

// DÃ©tecte le clic sur le bouton
document.getElementById("scrollTopBtn").addEventListener("click", scrollToTop);
</script>
<script>
function fermerPV() {
  const sheet = document.getElementById("sheet");
  if (sheet) sheet.style.display = "none";

  const closeBtn = document.getElementById("closePVBtn");
  if (closeBtn) closeBtn.style.display = "none";
  
   const scrollBtn = document.getElementById("scrollTopBtn");
  if (scrollBtn) scrollBtn.style.display = "none"; // ğŸ‘ˆ cache le bouton quand on ferme le PV

  window.scrollTo({ top: 0, behavior: "smooth" });
}
</script>
<script>
function showToast(message) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = message;
  t.style.display = 'block';
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(() => {
    t.style.display = 'none';
  }, 1500);
}
</script>



<div id="toast"></div>
</body>
</html>
